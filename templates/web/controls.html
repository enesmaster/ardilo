{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block css %}

<style>
    .noselect {
        -webkit-touch-callout: none; /* iOS Safari */
          -webkit-user-select: none; /* Safari */
           -khtml-user-select: none; /* Konqueror HTML */
             -moz-user-select: none; /* Old versions of Firefox */
              -ms-user-select: none; /* Internet Explorer/Edge */
                  user-select: none; /* Non-prefixed version, currently
                                        supported by Chrome, Opera and Firefox */
      }
      .response {
        position: absolute;
        right: 60px;
        font-size: 22px;
        text-shadow: 0px 6px 6px #13ba99;
        font-weight: bold;
        font-family: 'Cerebri Sans', sans-serif;
        background-color: #c8f7e7;
      }
      #dots {
        font-size: 25px;
        position: absolute;
        right: 20px;
        top: 10px;
        cursor:pointer;
      }
      .detail{
        position: absolute;
        width: 119px;
        height: 83px;
        background: white;
        box-shadow: 1px 1px 4px 2px #1c7d63;
        text-align: center;
        top: 36px;
        z-index: 1;
        left: 248px;
        border-radius: 5px;
        font-size: 18px;
        font-weight: bold;
        font-family: 'Cerebri Sans', sans-serif;
        display: grid;
        display:none;
        grid-template-columns: 2fr ;
        }
        .detail a {
          text-decoration: none;
          cursor: pointer;
        }
        .detail a:nth-child(1):hover{
          background: #1c7d63;
          color: white;
        }
        .detail a:nth-child(3):hover{
          background: red;
          color: white !important;
        }
        .detail a:nth-child(2):hover{
            background: #ac96c8;
            color: black !important;
        }
        .mmx {
            position: absolute;
            top: 20%;
            left: 15%;
            font-size: 22px;
            font-weight: bold;
          }
        .title_edit_input{
            border-radius: 10px;
            text-align: center;
            border: 1px solid #dddedf;
            position: absolute;
            top: 16px;
            left: 35%;
            display: none;
            width: 140px;
        }
        .title_edit_text{
            display: none;
            text-align: center;
            font-size: 14px;
            position: absolute;
            top: 62px;
            left: 35%;
        }
        .color-ball{
            position: relative;
            border-radius: 40%;
            margin-top: 2px;
            width:29px;
            height29px;
            display:inline;
        }
</style>
{% endblock css %}
{% block content %}

<!-- home-agency start -->
<section class="hero-5" id="home">
    <div class="container">
        <div class="row align-items-center justify-content-center">
            <div id="main" class="col-lg-2">
                <h1 id="main_title" class="mb-4 display-6 fw-semibold noselect">{% translate "Control buttons" %} </h1>
                <p id="main_p" class="text-muted fs-17 noselect">{% if request.user.is_authenticated %}{% if request.user.workshop %}{% translate "Control your projects by pressing the buttons"%} {% else %}{% translate "Create your worksop. But first take a look to the documentation." %} {% endif %}{% else %}  {% translate "Register an account, define your url in your Arduino/NodeMCU IDE. That's it!" %}{% endif %}</p>
                <a href="{% url 'docs' %}" id="learn_btn" class="btn btn-lg btn-gradient-success mt-4 mb-4 mb-lg-0">{% translate "Learn More"  %}<i class="mdi mdi-arrow-right fs-14 ms-1"></i></a>
            </div>

            {% if request.user.is_authenticated %}
            <div class="col-md-8 col-lg-5 offset-lg-1">
                {% for workshop in workshops %}
                <div class="card mb-3" id="card" data-card="{{forloop.counter}}" data-workshop-id-card="{{ workshop.id }}">
                    <div class="card-body p-4 ">
                        <i class='bx bx-dots-horizontal-rounded dots' id="dots" data-dot="{{forloop.counter}}"></i>
                            <div class="detail" id="detail" data-card="{{forloop.counter}}">
                                <a target="_blank" href="{{workshop.url}}">{% translate "Link"  %}</a>
                                <a class="edit-workshop">{% translate "Edit" %}</a>
                                <a class="delete-request">{% translate "Delete"  %}</a>
                            </div>
                        <h5 id="wifi_h5" class="border-bottom text-center fs-22 pb-2 mb-4 noselect">{{workshop.actname}}</h5>
                        <input type="text" class="title_edit_input" id="edit_actname_input" value="" placeholder="{% translate 'name...' %}">
                        <p id="title_edit_text" class="title_edit_text">{% translate "Press 'enter' to save" %}<br>{% translate "Press 'esc' to cancel" %}</p>
                        <p id="response" class="response">{{workshop.current_resp}}</p>
                        <a data-workshop-id="{{ workshop.id }}" data-workshop-def="{{ workshop.def_resp }}" data-workshop-exp="{{ workshop.expected_resp }}" class="btn btn-md {{workshop.button_color}} mt-0 mb-4 mb-lg-0 wake">{{workshop.expected_resp|title}}<i class="mdi mdi-arrow-right fs-14 ms-1"></i></a>
                        <div style=""> <br>
                            {% for color in btns  %}
                            <span class="color-ball {{color}}  ">&nbsp &nbsp &nbsp &nbsp</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mmx" style="text-align:center;display:none;">
                       <p>{% translate "Are you sure to Delete" %} "{{workshop.actname}}" ?<p>
                       <a style="
                           cursor: pointer;
                           background: #362d64;
                           border-radius: 20%;
                           padding-left: 5px;
                           padding-right: 10px;
                           color: white;
                           font-size: 18px;
                       " class="delete-workshop"><i class='bx bx-trash'></i>  {% translate "Yes" %}</a>
                        &nbsp;&nbsp; | &nbsp;&nbsp;
                        <a style="
                            cursor: pointer;
                            background: #362d64;
                            border-radius: 20%;
                            padding-left: 5px;
                            padding-right: 10px;
                            color: white;
                            font-size: 18px;" class="delete-giveup"><i class='bx bx-redo'></i> {% translate "No" %}</a>  
                    </div>
                </div>
                {% endfor %}
                <div class="no-workshop" style="display:none;">
                    <br>
                    <h5 class="text-center">{% translate "You don't have any workshop yet" %}</h5>
                    <a href="{% url 'config' %}" class="btn btn-lg btn-gradient-success mt-4 mb-4 mb-lg-0" style="margin-left: 30%;">{% translate "Create Now"  %}<i class="mdi mdi-arrow-right fs-14 ms-1"></i></a>
                </div>
            {% else %}
            <a href="{% url 'signup' %}"  class="btn btn-lg btn-gradient-success mt-4 mb-4 mb-lg-0">{% translate "Sign-Up"  %}<i class="mdi mdi-arrow-right fs-14 ms-1"></i></a>
            {% endif %}
        </div>
    </div>
 </section>
 <!-- home-agency end -->
{% endblock content %}
{% block script %}
<script>
    $('.wake').click(function(){
        var workshop_id = $(this).attr('data-workshop-id');
        var workshop_def = $(this).attr('data-workshop-def');
        var workshop_exp = $(this).attr('data-workshop-exp');
            $.ajax({
                type: "POST",
                url: "{% url 'control_panel' %}",
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {
                    'operation':'wake',
                    'workshop_id':workshop_id,
                    'workshop_def':workshop_def,
                    'workshop_exp':workshop_exp},
                dataType: "json",
                success: function(response) {
                     if(response.success == true){
                        a = $("[data-workshop-id='"+workshop_id+"']");
                        $(a).siblings('#response').text(response.response);
                        $(a).siblings('#response').css('padding','0.9px');
                        setTimeout(function(){
                            $(a).siblings('#response').css('padding','0');
                        },120);
                        $(a).text(response.resp_btn);
                        $(a).text(function(i) {
                            return a.text().substr(0,1).toUpperCase() + a.text().substr(1);
                        });
                        $(a).html($(a).html() + '<i class="mdi mdi-arrow-right fs-14 ms-1"></i>');

                     }
                     else if(response.status==false){
                       console.log(response.status)
                     }
                     else if(response.status=='duplicate'){
                        $('#wifi_alert_p').show()
                        $('#wifi_alert_p').html(response.msg)
                        setTimeout(function(){
                            $('#wifi_alert_p').hide()
                        },12000)
                    }
                 },
                 error: function(rs, e) {
                  console.log('error')
                 }
           }); 
        });
        $('.delete-request').click(function(){
            _id = $(this).parent().parent().find('#dots').attr('data-dot');
            card = $('.card').filter('[data-card="'+_id+'"]');
            card.find('h5').css('filter','blur(0.2rem)').css('pointer-events','none');
            card.find('a[data-workshop-def]').css('filter','blur(2px)').css('pointer-events','none');
            card.find('p[id]').css('filter','blur(2px)').css('pointer-events','none');
            card.find('i[id]').css('display','none');
            card.find('div[id]').css('display','none');
            card.find('.mmx').css('display','block');
        });
        $('.edit-workshop').click(function(){
            $(this).find('#detail').css('display','none');
            _id = $(this).parent().parent().find('#dots').attr('data-dot');
            card = $('.card').filter('[data-card="'+_id+'"]');
            card.find('div[id]').css('display','none'); // close dots tab
            card.find('#edit_actname_input').css('display','block');
            card.find('#title_edit_text').css('display','block');
            card.find('#edit_actname_input').val( card.find('h5').text());
            card.find('#edit_actname_input').focus();
            card.find('#edit_actname_input').focusout(function(){
                card.find('#edit_actname_input').css('display','none');
                card.find('#title_edit_text').css('display','none');
            });
            
            document.onkeydown = function(evt) {
                evt = evt || window.event;
                var isEscape = false;
                var isEnter = false;
                if ("key" in evt) {
                    isEscape = (evt.key === "Escape" || evt.key === "Esc");
                } else {
                    isEscape = (evt.keyCode === 27);
                }
                if (isEscape) {
                    card.find('#edit_actname_input').trigger('focusout');
                }
                //  -- Enter key
                if ("key" in evt) {
                    isEnter = (evt.key === "Enter" || evt.key === "Enter");
                } else {
                    isEnter = (evt.keyCode === 13);
                }
                if (isEnter) {
                    $.ajax({
                        type: "POST",
                        url: "{% url 'control_panel' %}",
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        data: {
                            'operation':'update-workshop',
                            'workshop_id': card.attr('data-workshop-id-card'),
                            'new_name': card.find('#edit_actname_input').val(),
                        },
                            dataType: "json",
                            success: function(response) {
                                if(response.success == true){
                                    card.find('h5').text(response.new_name);
                                    card.find('#edit_actname_input').trigger('focusout');

                                   console.log('fdbjgngbkmfödslağalfkgodm')
                                   console.log('done')
                                    setTimeout(function(){
                                        card.find('#title_text').css('padding','0');
                                    },120);
                                }
                                else if(response.status==false){
                                    console.log(response.status)
                                }
                            },
                             error: function(response) {
                              console.log('error')
                            }
                    });
                }
            };
        });

        $('.delete-giveup').click(function(){
            var _id = $(this).parent().parent().parent().attr('data-card')
            card = $('.card').filter('[data-card="'+_id+'"]');
            card.find('h5').css('filter','blur(0.0rem)').css('pointer-events','auto');
            card.find('a[data-workshop-def]').css('filter','blur(0px)').css('pointer-events','auto');
            card.find('p[id]').css('filter','blur(0px)').css('pointer-events','auto');
            card.find('i[id]').css('display','block');
            card.find('div[id]').css('display','block');
            card.find('.mmx').css('display','none');
            card.find('#detail').css('display','none');
        });
        $('.delete-workshop').click(function(){            
            //var workshop_card_id = $(this).parent().parent().attr('data-card');
            var workshop_id = $(this).parent().parent().parent().attr('data-workshop-id-card');
                $.ajax({
                    type: "POST",
                    url: "{% url 'control_panel' %}",
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'operation':'delete-workshop',
                        'workshop_id':workshop_id
                    },
                        dataType: "json",
                        success: function(response) {
                            if(response.success == true){
                           console.log(response.status) //always "deleted" :)
                           card = $('.card').filter('[data-card="'+response.workshop_id+'"]');
                           card.find('.mmx').html(response.msg);
                           setTimeout(function(){
                               card.remove();
                           },2000);   
                         }
                         else if(response.status==false){
                           console.log(response.status)
                         }
                         else if(response.status=='duplicate'){
                            console.log(response.status)
                        }
                     },
                     error: function(rs, e) {
                      console.log('error')
                     }
               }); 
            });
        $('.dots').click(function(){
            dot_id = $(this).data('dot');
            console.log(dot_id);
            card = $('.detail[data-card="'+dot_id+'"]');
            if (card.css('display') == 'none'){
                card.css('display','grid');
            }else{
                card.css('display','none');
            }
        });
        $('.detail').mouseover(function(){
            $(this).css('display','grid');
        }).mouseout(function(){
            $(this).css('display','none');
        });
        if ($('.card').length == 0){
            $('.no-workshop').css('display','block');
            $('#main').css('display','none');
            
        }

        
</script>

{% endblock script %}